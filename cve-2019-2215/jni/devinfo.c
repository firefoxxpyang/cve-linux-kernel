#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <inttypes.h>

#include "common.h"
#include "devinfo.h"

#define KERNELVER_LEN 256

struct devinfo *dev_info;

struct devinfo devinfo[] = {
	{
		.flag = DEVINFO_OFFSET_NO,
		.devname = "Linux localhost",
		.kernver = "4.4",
		.binder_thread_size = 0x198,
		.offset_binder_task = 0x190,
		.offset_binder_next = 0xa8,
		.offset_binder_wait = 0xa0,
		.offset_binder_next_task = 0xe8,
		.offset_task_stack = 0,
		.offset_task_cred = 0,
		.offset_task_sched_class = 0,
		.offset_addr_limit = 0x8,
		.offset_selinux = 0,
		.kern_copy_offset = 0,
		.kern_copy_size = 4*0x100000,//4MB
	},
	{
		.flag = DEVINFO_OFFSET_NO,
		.devname = "Linux localhost",
		.kernver = "4.4.124+",
		.binder_thread_size = 0x198,
		.offset_binder_task = 0x190,
		.offset_binder_next = 0xa8,
		.offset_binder_wait = 0xa0,
		.offset_binder_next_task = 0xe8,
		.offset_task_stack = 0x8,
		.offset_task_cred = 0x940,
		.offset_task_sched_class = 0x58,
		.offset_addr_limit = 0x18,
		.offset_selinux = 0x75ef90,
		.kern_copy_offset = 0,
		.kern_copy_size = 4*0x100000,//4MB
	},
	{   // vivo V1818A
		.flag = DEVINFO_OFFSET_NO,
		.devname = "Linux localhost",
		.kernver = "4.9.82-perf+",
		.binder_thread_size = 0x198,
		.offset_binder_task = 0x190,
		.offset_binder_next = 0xa8,
		.offset_binder_wait = 0xa0,
		.offset_binder_next_task = 0xe8,
		.offset_task_stack = 0x38,
		.offset_task_cred = 0x6a0,//0x850,
		.offset_task_sched_class = 0x90,
		.offset_addr_limit = 0x8,
		.offset_selinux = 0x1113a40,
		.kern_copy_offset = 0x3f0000,
		.kern_copy_size = 4*0x100000,//4MB
	},
	{	// Honor 8 Lite PRA-AL00X
		.flag = DEVINFO_OFFSET_NO,
		.devname = "Linux localhost",
		.kernver = "4.4.23+",
		.binder_thread_size = 0x1a0,
		.offset_binder_task = 0x198,
		.offset_binder_next = 0xb0,
		.offset_binder_wait = 0xa8,
		.offset_binder_next_task = 0xe8,
		.offset_task_stack = 0x8,
		.offset_task_cred = 0x618,
		.offset_task_sched_class = 0x88,
		.offset_addr_limit = 0x8,
		.offset_selinux = 0x483bf8,
		.kern_copy_offset = 0x100000,
		.kern_copy_size = 4*0x100000,//4MB
	},
};

struct devinfo* get_devinfo(void)
{
	unsigned int i;
	struct devinfo* ptr = NULL;
	char* kernver = malloc(KERNELVER_LEN);

	if(!kernver){
		printf(">>> [%s] malloc failed!\n", __FUNCTION__);
	}
	memset(kernver, 0, KERNELVER_LEN);

	if(get_kernel_info(kernver))
		goto end;
	//printf(">>> [%s] kernver: %s\n", __FUNCTION__, kernver);

	for(i = 0; i < ARRAY_SIZE(devinfo); i++)
	{
		if(strcmp(kernver, devinfo[i].kernver))
			continue;
		ptr = &devinfo[i];
		break;
	}
end:
	if(ptr == NULL) {
		ptr = &devinfo[0];
		printf("    未找到适配机型，采用默认参数\n");
	}
	free(kernver);

	return ptr;
}
